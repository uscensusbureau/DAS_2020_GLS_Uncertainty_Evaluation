import numpy as np
from functools import reduce


def create_elements_in_interval(lb=1, ub=63):
    return tuple(('' if x > 9 else '0') + str(x) for x in range(1, 64) if lb <= x <= ub)

# To create the dictionary below, I copied/pasted it from FPGuide/query_tool.py, replaced each tabulation attribute name with the corresponding DAS attribute name,
# and replaced intervals of the form "cenrace >= lb and cenrace <= ub", with f"{create_elements_in_interval(lb, ub)}":


qry_dict_p = {"P0010001": "",
              "P0010002": f"cenrace in {create_elements_in_interval(ub=6)}",
              "P0010003": "cenrace in ('01')",
              "P0010004": "cenrace in ('02')",
              "P0010005": "cenrace in ('03')",
              "P0010006": "cenrace in ('04')",
              "P0010007": "cenrace in ('05')",
              "P0010008": "cenrace in ('06')",
              "P0010009": f"cenrace in {create_elements_in_interval(lb=7)}",
              "P0010010": f"cenrace in {create_elements_in_interval(7,21)}",
              "P0010011": "cenrace in ('07')",
              "P0010012": "cenrace in ('08')",
              "P0010013": "cenrace in ('09')",
              "P0010014": "cenrace in ('10')",
              "P0010015": "cenrace in ('11')",
              "P0010016": "cenrace in ('12')",
              "P0010017": "cenrace in ('13')",
              "P0010018": "cenrace in ('14')",
              "P0010019": "cenrace in ('15')",
              "P0010020": "cenrace in ('16')",
              "P0010021": "cenrace in ('17')",
              "P0010022": "cenrace in ('18')",
              "P0010023": "cenrace in ('19')",
              "P0010024": "cenrace in ('20')",
              "P0010025": "cenrace in ('21')",
              "P0010026": f"cenrace in {create_elements_in_interval(22, 41)}",
              "P0010027": "cenrace in ('22')",
              "P0010028": "cenrace in ('23')",
              "P0010029": "cenrace in ('24')",
              "P0010030": "cenrace in ('25')",
              "P0010031": "cenrace in ('26')",
              "P0010032": "cenrace in ('27')",
              "P0010033": "cenrace in ('28')",
              "P0010034": "cenrace in ('29')",
              "P0010035": "cenrace in ('30')",
              "P0010036": "cenrace in ('31')",
              "P0010037": "cenrace in ('32')",
              "P0010038": "cenrace in ('33')",
              "P0010039": "cenrace in ('34')",
              "P0010040": "cenrace in ('35')",
              "P0010041": "cenrace in ('36')",
              "P0010042": "cenrace in ('37')",
              "P0010043": "cenrace in ('38')",
              "P0010044": "cenrace in ('39')",
              "P0010045": "cenrace in ('40')",
              "P0010046": "cenrace in ('41')",
              "P0010047": f"cenrace in {create_elements_in_interval(42,56)}",
              "P0010048": "cenrace in ('42')",
              "P0010049": "cenrace in ('43')",
              "P0010050": "cenrace in ('44')",
              "P0010051": "cenrace in ('45')",
              "P0010052": "cenrace in ('46')",
              "P0010053": "cenrace in ('47')",
              "P0010054": "cenrace in ('48')",
              "P0010055": "cenrace in ('49')",
              "P0010056": "cenrace in ('50')",
              "P0010057": "cenrace in ('51')",
              "P0010058": "cenrace in ('52')",
              "P0010059": "cenrace in ('53')",
              "P0010060": "cenrace in ('54')",
              "P0010061": "cenrace in ('55')",
              "P0010062": "cenrace in ('56')",
              "P0010063": f"cenrace in {create_elements_in_interval(57, 62)}",
              "P0010064": "cenrace in ('57')",
              "P0010065": "cenrace in ('58')",
              "P0010066": "cenrace in ('59')",
              "P0010067": "cenrace in ('60')",
              "P0010068": "cenrace in ('61')",
              "P0010069": "cenrace in ('62')",
              "P0010070": "cenrace in ('63')",
              "P0010071": "cenrace in ('63')",
              "P0020001": "",
              "P0020002": "hispanic in ('2')",
              "P0020003": "hispanic in ('1')",
              "P0020004": f"hispanic in ('1') and cenrace in {create_elements_in_interval(ub=6)}",
              "P0020005": "hispanic in ('1') and cenrace in ('01')",
              "P0020006": "hispanic in ('1') and cenrace in ('02')",
              "P0020007": "hispanic in ('1') and cenrace in ('03')",
              "P0020008": "hispanic in ('1') and cenrace in ('04')",
              "P0020009": "hispanic in ('1') and cenrace in ('05')",
              "P0020010": "hispanic in ('1') and cenrace in ('06')",
              "P0020011": f"hispanic in ('1') and cenrace in {create_elements_in_interval(lb=7)}",
              "P0020012": f"hispanic in ('1') and cenrace in {create_elements_in_interval(7,21)}",
              "P0020013": "hispanic in ('1') and cenrace in ('07')",
              "P0020014": "hispanic in ('1') and cenrace in ('08')",
              "P0020015": "hispanic in ('1') and cenrace in ('09')",
              "P0020016": "hispanic in ('1') and cenrace in ('10')",
              "P0020017": "hispanic in ('1') and cenrace in ('11')",
              "P0020018": "hispanic in ('1') and cenrace in ('12')",
              "P0020019": "hispanic in ('1') and cenrace in ('13')",
              "P0020020": "hispanic in ('1') and cenrace in ('14')",
              "P0020021": "hispanic in ('1') and cenrace in ('15')",
              "P0020022": "hispanic in ('1') and cenrace in ('16')",
              "P0020023": "hispanic in ('1') and cenrace in ('17')",
              "P0020024": "hispanic in ('1') and cenrace in ('18')",
              "P0020025": "hispanic in ('1') and cenrace in ('19')",
              "P0020026": "hispanic in ('1') and cenrace in ('20')",
              "P0020027": "hispanic in ('1') and cenrace in ('21')",
              "P0020028": f"hispanic in ('1') and cenrace in {create_elements_in_interval(22, 41)}",
              "P0020029": "hispanic in ('1') and cenrace in ('22')",
              "P0020030": "hispanic in ('1') and cenrace in ('23')",
              "P0020031": "hispanic in ('1') and cenrace in ('24')",
              "P0020032": "hispanic in ('1') and cenrace in ('25')",
              "P0020033": "hispanic in ('1') and cenrace in ('26')",
              "P0020034": "hispanic in ('1') and cenrace in ('27')",
              "P0020035": "hispanic in ('1') and cenrace in ('28')",
              "P0020036": "hispanic in ('1') and cenrace in ('29')",
              "P0020037": "hispanic in ('1') and cenrace in ('30')",
              "P0020038": "hispanic in ('1') and cenrace in ('31')",
              "P0020039": "hispanic in ('1') and cenrace in ('32')",
              "P0020040": "hispanic in ('1') and cenrace in ('33')",
              "P0020041": "hispanic in ('1') and cenrace in ('34')",
              "P0020042": "hispanic in ('1') and cenrace in ('35')",
              "P0020043": "hispanic in ('1') and cenrace in ('36')",
              "P0020044": "hispanic in ('1') and cenrace in ('37')",
              "P0020045": "hispanic in ('1') and cenrace in ('38')",
              "P0020046": "hispanic in ('1') and cenrace in ('39')",
              "P0020047": "hispanic in ('1') and cenrace in ('40')",
              "P0020048": "hispanic in ('1') and cenrace in ('41')",
              "P0020049": f"hispanic in ('1') and cenrace in {create_elements_in_interval(42, 56)}",
              "P0020050": "hispanic in ('1') and cenrace in ('42')",
              "P0020051": "hispanic in ('1') and cenrace in ('43')",
              "P0020052": "hispanic in ('1') and cenrace in ('44')",
              "P0020053": "hispanic in ('1') and cenrace in ('45')",
              "P0020054": "hispanic in ('1') and cenrace in ('46')",
              "P0020055": "hispanic in ('1') and cenrace in ('47')",
              "P0020056": "hispanic in ('1') and cenrace in ('48')",
              "P0020057": "hispanic in ('1') and cenrace in ('49')",
              "P0020058": "hispanic in ('1') and cenrace in ('50')",
              "P0020059": "hispanic in ('1') and cenrace in ('51')",
              "P0020060": "hispanic in ('1') and cenrace in ('52')",
              "P0020061": "hispanic in ('1') and cenrace in ('53')",
              "P0020062": "hispanic in ('1') and cenrace in ('54')",
              "P0020063": "hispanic in ('1') and cenrace in ('55')",
              "P0020064": "hispanic in ('1') and cenrace in ('56')",
              "P0020065": f"hispanic in ('1') and cenrace in {create_elements_in_interval(57,62)}",
              "P0020066": "hispanic in ('1') and cenrace in ('57')",
              "P0020067": "hispanic in ('1') and cenrace in ('58')",
              "P0020068": "hispanic in ('1') and cenrace in ('59')",
              "P0020069": "hispanic in ('1') and cenrace in ('60')",
              "P0020070": "hispanic in ('1') and cenrace in ('61')",
              "P0020071": "hispanic in ('1') and cenrace in ('62')",
              "P0020072": "hispanic in ('1') and cenrace in ('63')",
              "P0020073": "hispanic in ('1') and cenrace in ('63')",
              "P0030001": "voting_age in ('2')",
              "P0030002": f"voting_age in ('2') and cenrace in {create_elements_in_interval(ub=6)}",
              "P0030003": "voting_age in ('2') and cenrace in ('01')",
              "P0030004": "voting_age in ('2') and cenrace in ('02')",
              "P0030005": "voting_age in ('2') and cenrace in ('03')",
              "P0030006": "voting_age in ('2') and cenrace in ('04')",
              "P0030007": "voting_age in ('2') and cenrace in ('05')",
              "P0030008": "voting_age in ('2') and cenrace in ('06')",
              "P0030009": f"voting_age in ('2') and cenrace in {create_elements_in_interval(lb=7)}",
              "P0030010": f"voting_age in ('2') and cenrace in {create_elements_in_interval(lb=7,ub=21)}",
              "P0030011": "voting_age in ('2') and cenrace in ('07')",
              "P0030012": "voting_age in ('2') and cenrace in ('08')",
              "P0030013": "voting_age in ('2') and cenrace in ('09')",
              "P0030014": "voting_age in ('2') and cenrace in ('10')",
              "P0030015": "voting_age in ('2') and cenrace in ('11')",
              "P0030016": "voting_age in ('2') and cenrace in ('12')",
              "P0030017": "voting_age in ('2') and cenrace in ('13')",
              "P0030018": "voting_age in ('2') and cenrace in ('14')",
              "P0030019": "voting_age in ('2') and cenrace in ('15')",
              "P0030020": "voting_age in ('2') and cenrace in ('16')",
              "P0030021": "voting_age in ('2') and cenrace in ('17')",
              "P0030022": "voting_age in ('2') and cenrace in ('18')",
              "P0030023": "voting_age in ('2') and cenrace in ('19')",
              "P0030024": "voting_age in ('2') and cenrace in ('20')",
              "P0030025": "voting_age in ('2') and cenrace in ('21')",
              "P0030026": f"voting_age in ('2') and cenrace in {create_elements_in_interval(22, 41)}",
              "P0030027": "voting_age in ('2') and cenrace in ('22')",
              "P0030028": "voting_age in ('2') and cenrace in ('23')",
              "P0030029": "voting_age in ('2') and cenrace in ('24')",
              "P0030030": "voting_age in ('2') and cenrace in ('25')",
              "P0030031": "voting_age in ('2') and cenrace in ('26')",
              "P0030032": "voting_age in ('2') and cenrace in ('27')",
              "P0030033": "voting_age in ('2') and cenrace in ('28')",
              "P0030034": "voting_age in ('2') and cenrace in ('29')",
              "P0030035": "voting_age in ('2') and cenrace in ('30')",
              "P0030036": "voting_age in ('2') and cenrace in ('31')",
              "P0030037": "voting_age in ('2') and cenrace in ('32')",
              "P0030038": "voting_age in ('2') and cenrace in ('33')",
              "P0030039": "voting_age in ('2') and cenrace in ('34')",
              "P0030040": "voting_age in ('2') and cenrace in ('35')",
              "P0030041": "voting_age in ('2') and cenrace in ('36')",
              "P0030042": "voting_age in ('2') and cenrace in ('37')",
              "P0030043": "voting_age in ('2') and cenrace in ('38')",
              "P0030044": "voting_age in ('2') and cenrace in ('39')",
              "P0030045": "voting_age in ('2') and cenrace in ('40')",
              "P0030046": "voting_age in ('2') and cenrace in ('41')",
              "P0030047": f"voting_age in ('2') and cenrace in {create_elements_in_interval(42,56)}",
              "P0030048": "voting_age in ('2') and cenrace in ('42')",
              "P0030049": "voting_age in ('2') and cenrace in ('43')",
              "P0030050": "voting_age in ('2') and cenrace in ('44')",
              "P0030051": "voting_age in ('2') and cenrace in ('45')",
              "P0030052": "voting_age in ('2') and cenrace in ('46')",
              "P0030053": "voting_age in ('2') and cenrace in ('47')",
              "P0030054": "voting_age in ('2') and cenrace in ('48')",
              "P0030055": "voting_age in ('2') and cenrace in ('49')",
              "P0030056": "voting_age in ('2') and cenrace in ('50')",
              "P0030057": "voting_age in ('2') and cenrace in ('51')",
              "P0030058": "voting_age in ('2') and cenrace in ('52')",
              "P0030059": "voting_age in ('2') and cenrace in ('53')",
              "P0030060": "voting_age in ('2') and cenrace in ('54')",
              "P0030061": "voting_age in ('2') and cenrace in ('55')",
              "P0030062": "voting_age in ('2') and cenrace in ('56')",
              "P0030063": f"voting_age in ('2') and cenrace in {create_elements_in_interval(57,62)}",
              "P0030064": "voting_age in ('2') and cenrace in ('57')",
              "P0030065": "voting_age in ('2') and cenrace in ('58')",
              "P0030066": "voting_age in ('2') and cenrace in ('59')",
              "P0030067": "voting_age in ('2') and cenrace in ('60')",
              "P0030068": "voting_age in ('2') and cenrace in ('61')",
              "P0030069": "voting_age in ('2') and cenrace in ('62')",
              "P0030070": "voting_age in ('2') and cenrace in ('63')",
              "P0030071": "voting_age in ('2') and cenrace in ('63')",
              "P0040001": "voting_age in ('2')",
              "P0040002": "voting_age in ('2') and hispanic in ('2')",
              "P0040003": "voting_age in ('2') and hispanic in ('1')",
              "P0040004": f"voting_age in ('2') and hispanic in ('1') and cenrace in {create_elements_in_interval(1,6)}",
              "P0040005": "voting_age in ('2') and hispanic in ('1') and cenrace in ('01')",
              "P0040006": "voting_age in ('2') and hispanic in ('1') and cenrace in ('02')",
              "P0040007": "voting_age in ('2') and hispanic in ('1') and cenrace in ('03')",
              "P0040008": "voting_age in ('2') and hispanic in ('1') and cenrace in ('04')",
              "P0040009": "voting_age in ('2') and hispanic in ('1') and cenrace in ('05')",
              "P0040010": "voting_age in ('2') and hispanic in ('1') and cenrace in ('06')",
              "P0040011": f"voting_age in ('2') and hispanic in ('1') and cenrace in {create_elements_in_interval(lb=7)}",
              "P0040012": f"voting_age in ('2') and hispanic in ('1') and cenrace in {create_elements_in_interval(7, 21)}",
              "P0040013": "voting_age in ('2') and hispanic in ('1') and cenrace in ('07')",
              "P0040014": "voting_age in ('2') and hispanic in ('1') and cenrace in ('08')",
              "P0040015": "voting_age in ('2') and hispanic in ('1') and cenrace in ('09')",
              "P0040016": "voting_age in ('2') and hispanic in ('1') and cenrace in ('10')",
              "P0040017": "voting_age in ('2') and hispanic in ('1') and cenrace in ('11')",
              "P0040018": "voting_age in ('2') and hispanic in ('1') and cenrace in ('12')",
              "P0040019": "voting_age in ('2') and hispanic in ('1') and cenrace in ('13')",
              "P0040020": "voting_age in ('2') and hispanic in ('1') and cenrace in ('14')",
              "P0040021": "voting_age in ('2') and hispanic in ('1') and cenrace in ('15')",
              "P0040022": "voting_age in ('2') and hispanic in ('1') and cenrace in ('16')",
              "P0040023": "voting_age in ('2') and hispanic in ('1') and cenrace in ('17')",
              "P0040024": "voting_age in ('2') and hispanic in ('1') and cenrace in ('18')",
              "P0040025": "voting_age in ('2') and hispanic in ('1') and cenrace in ('19')",
              "P0040026": "voting_age in ('2') and hispanic in ('1') and cenrace in ('20')",
              "P0040027": "voting_age in ('2') and hispanic in ('1') and cenrace in ('21')",
              "P0040028": f"voting_age in ('2') and hispanic in ('1') and cenrace in {create_elements_in_interval(22,41)}",
              "P0040029": "voting_age in ('2') and hispanic in ('1') and cenrace in ('22')",
              "P0040030": "voting_age in ('2') and hispanic in ('1') and cenrace in ('23')",
              "P0040031": "voting_age in ('2') and hispanic in ('1') and cenrace in ('24')",
              "P0040032": "voting_age in ('2') and hispanic in ('1') and cenrace in ('25')",
              "P0040033": "voting_age in ('2') and hispanic in ('1') and cenrace in ('26')",
              "P0040034": "voting_age in ('2') and hispanic in ('1') and cenrace in ('27')",
              "P0040035": "voting_age in ('2') and hispanic in ('1') and cenrace in ('28')",
              "P0040036": "voting_age in ('2') and hispanic in ('1') and cenrace in ('29')",
              "P0040037": "voting_age in ('2') and hispanic in ('1') and cenrace in ('30')",
              "P0040038": "voting_age in ('2') and hispanic in ('1') and cenrace in ('31')",
              "P0040039": "voting_age in ('2') and hispanic in ('1') and cenrace in ('32')",
              "P0040040": "voting_age in ('2') and hispanic in ('1') and cenrace in ('33')",
              "P0040041": "voting_age in ('2') and hispanic in ('1') and cenrace in ('34')",
              "P0040042": "voting_age in ('2') and hispanic in ('1') and cenrace in ('35')",
              "P0040043": "voting_age in ('2') and hispanic in ('1') and cenrace in ('36')",
              "P0040044": "voting_age in ('2') and hispanic in ('1') and cenrace in ('37')",
              "P0040045": "voting_age in ('2') and hispanic in ('1') and cenrace in ('38')",
              "P0040046": "voting_age in ('2') and hispanic in ('1') and cenrace in ('39')",
              "P0040047": "voting_age in ('2') and hispanic in ('1') and cenrace in ('40')",
              "P0040048": "voting_age in ('2') and hispanic in ('1') and cenrace in ('41')",
              "P0040049": f"voting_age in ('2') and hispanic in ('1') and cenrace in {create_elements_in_interval(42,56)}",
              "P0040050": "voting_age in ('2') and hispanic in ('1') and cenrace in ('42')",
              "P0040051": "voting_age in ('2') and hispanic in ('1') and cenrace in ('43')",
              "P0040052": "voting_age in ('2') and hispanic in ('1') and cenrace in ('44')",
              "P0040053": "voting_age in ('2') and hispanic in ('1') and cenrace in ('45')",
              "P0040054": "voting_age in ('2') and hispanic in ('1') and cenrace in ('46')",
              "P0040055": "voting_age in ('2') and hispanic in ('1') and cenrace in ('47')",
              "P0040056": "voting_age in ('2') and hispanic in ('1') and cenrace in ('48')",
              "P0040057": "voting_age in ('2') and hispanic in ('1') and cenrace in ('49')",
              "P0040058": "voting_age in ('2') and hispanic in ('1') and cenrace in ('50')",
              "P0040059": "voting_age in ('2') and hispanic in ('1') and cenrace in ('51')",
              "P0040060": "voting_age in ('2') and hispanic in ('1') and cenrace in ('52')",
              "P0040061": "voting_age in ('2') and hispanic in ('1') and cenrace in ('53')",
              "P0040062": "voting_age in ('2') and hispanic in ('1') and cenrace in ('54')",
              "P0040063": "voting_age in ('2') and hispanic in ('1') and cenrace in ('55')",
              "P0040064": "voting_age in ('2') and hispanic in ('1') and cenrace in ('56')",
              "P0040065": f"voting_age in ('2') and hispanic in ('1') and cenrace in {create_elements_in_interval(57, 62)}",
              "P0040066": "voting_age in ('2') and hispanic in ('1') and cenrace in ('57')",
              "P0040067": "voting_age in ('2') and hispanic in ('1') and cenrace in ('58')",
              "P0040068": "voting_age in ('2') and hispanic in ('1') and cenrace in ('59')",
              "P0040069": "voting_age in ('2') and hispanic in ('1') and cenrace in ('60')",
              "P0040070": "voting_age in ('2') and hispanic in ('1') and cenrace in ('61')",
              "P0040071": "voting_age in ('2') and hispanic in ('1') and cenrace in ('62')",
              "P0040072": "voting_age in ('2') and hispanic in ('1') and cenrace in ('63')",
              "P0040073": "voting_age in ('2') and hispanic in ('1') and cenrace in ('63')",
              "P0050001": "hhgq in ('1', '2', '3', '4', '5', '6', '7')",
              "P0050002": "hhgq in ('1', '2', '3', '4')",
              "P0050003": "hhgq in ('1')",
              "P0050004": "hhgq in ('2')",
              "P0050005": "hhgq in ('3')",
              "P0050006": "hhgq in ('4')",
              "P0050007": "hhgq in ('5', '6', '7')",
              "P0050008": "hhgq in ('5')",
              "P0050009": "hhgq in ('6')",
              "P0050010": "hhgq in ('7')"}


def create_pl94_query_mats():
    attrs = ["hhgq", "voting_age", "hispanic", "cenrace"]
    n_levels = {"hhgq": 8, "voting_age": 2, "hispanic": 2, "cenrace": 63}
    # Each levels given in the values of qry_dict_p can be converted to (0-based) python indices of DAS schema attributes by subtracting either 0 or 1:
    levels_to_das_attr_recode_constant = {"hhgq": 0, "voting_age": 1, "hispanic": 1, "cenrace": 1}
    ones = {attr: np.ones(n_levels[attr]) for attr in attrs}

    lin_query_dict = {}
    for key, val in qry_dict_p.items():
        qs = val.split(" and ")
        kron_factors = []
        for attr in attrs:
            attr_in_qs = [attr in q for q in qs]
            if np.any(attr_in_qs):
                qs_ind = np.nonzero(attr_in_qs)[0]
                assert len(qs_ind) == 1
                q = qs[qs_ind[0]]
                # Take everything after " in ('" and then remove the final "')":
                levels_str = q.split(" in ('")[1][:-2]
                levels = [int(x) - levels_to_das_attr_recode_constant[attr] for x in levels_str.split("', '")]
                kron_fac = np.zeros(n_levels[attr])
                kron_fac[levels] = 1
                kron_factors.append(kron_fac)
            else:
                kron_factors.append(ones[attr])
        # print({key: kron_factors})
        lin_query_dict[key] = reduce(np.kron, kron_factors)
    return lin_query_dict
